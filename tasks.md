# ูุธุงู ู ูุดฺฉูุงุช ูพุฑูฺู ูุฑูุดุงุฑ

## โ ูุดฺฉูุงุช ุฑูุน ุดุฏู

### 1. ูุดฺฉู ุชููู ฺฉุงุฑ ุชุญูู (Analysis Job)
- **ูุดฺฉู**: ฺฉุงุฑ ุชุญูู ูพุณ ุงุฒ ุฑูุฑุด ุตูุญู ูุชููู ูโุดุฏ
- **ุนูุช**: ุงุณุชูุงุฏู ุงุฒ WordPress Cron ฺฉู ููุท ุจุง ุจุงุฒุฏุฏ ุตูุญู ุงุฌุฑุง ูโุดูุฏ
- **ุฑุงูโุญู**: 
  - ุฐุฎุฑู ูุถุนุช ฺฉุงุฑ ุฏุฑ ุฌุฏูู `aiagent_scheduled` ุจุฑุง ูพุงุฏุงุฑ
  - ุงุณุชูุงุฏู ุงุฒ WordPress Heartbeat API ุจุฑุง ูุธุงุฑุช ูุฏุงูู
  - ุงุถุงูู ฺฉุฑุฏู ูฺฉุงูุฒู ุจุงุฒุงุจ ฺฉุงุฑูุง ูุชููู ุดุฏู
  - ุงุฑุณุงู ุฏุฑุฎูุงุณุช async ุจุฑุง ุงุทููุงู ุงุฒ ุงุฌุฑุง cron

### 1.1 ูุดฺฉู ุนุฏู ูพุฑุฏุงุฒุด ฺฉุงุฑ ุชุญูู โ
- **ูุดฺฉู**: ฺฉุงุฑ ุชุญูู ุดุฑูุน ูโุดุฏ ุงูุง ูฺ ูุญุตูู ุง ูุดุชุฑ ุจู LLM ุงุฑุณุงู ููโุดุฏ
- **ุนูุช**: WordPress Cron ููุท ุจุง ุจุงุฒุฏุฏ ุตูุญู ุงุฌุฑุง ูโุดูุฏ ู timeout ุฏุฑุฎูุงุณุช async ุฎู ฺฉูุชุงู ุจูุฏ
- **ุฑุงูโุญู ุงููู** (ูุดฺฉูโุฏุงุฑ): ูพุฑุฏุงุฒุด ุฏุฑ ูุฑ poll request ฺฉู ุจุงุนุซ overload ุณุฑูุฑ ูโุดุฏ
- **ุฑุงูโุญู ููุง**:
  - ุฌุฏุงุณุงุฒ ุฏุฑุฎูุงุณุช ูพุฑุฏุงุฒุด (`aiagent_process_batch`) ุงุฒ ุฏุฑุฎูุงุณุช progress (`aiagent_get_analysis_progress`)
  - ุฏุฑุฎูุงุณุช ูพุฑุฏุงุฒุด: timeout ุจุงูุง (5 ุฏููู)ุ ููุชุธุฑ ูพุงุณุฎ LLM ูโูุงูุฏุ ูพุณ ุงุฒ ุงุชูุงู ุฎูุฏฺฉุงุฑ batch ุจุนุฏ ุฑุง ุดุฑูุน ูโฺฉูุฏ
  - ุฏุฑุฎูุงุณุช progress: ุณุจฺฉุ ููุท ูุถุนุช ุฑุง ูโุฎูุงูุฏุ ูุฑ 2 ุซุงูู
  - ุงู ูุนูุงุฑ ุงุฒ overload ุณุฑูุฑ ุฌููฺฏุฑ ูโฺฉูุฏ ู ูพุฑุฏุงุฒุด ูพุงุฏุงุฑ ุฑุง ุชุถูู ูโฺฉูุฏ

### 2. ุฌุฏูู `aiagent_context` ุงุณุชูุงุฏู ูุดุฏู โ
- **ูุดฺฉู**: ุฌุฏูู ุงุฌุงุฏ ูโุดุฏ ุงูุง ูฺโุฌุง ุงุณุชูุงุฏู ููโุดุฏ
- **ุฑุงูโุญู**: 
  - ุงุฌุงุฏ ุณุฑูุณ `ContextManager` ุฏุฑ `src/Modules/AIAgent/Services/ContextManager.php`
  - ูุฏุฑุช ูพุฑุงููพุชโูุง ู ูุงูุจโูุง ุณุณุชู
  - ูพุดุชุจุงู ุงุฒ import/export
  - ูุงุจูุช reset ุจู ููุงุฏุฑ ูพุดโูุฑุถ
  - ฺฉุด ุฏุงุฎู ุจุฑุง ุจูุจูุฏ ุนููฺฉุฑุฏ

### 3. ุฌุฏูู `aiagent_scheduled` ุงุณุชูุงุฏู ูุงูุต โ
- **ูุดฺฉู**: ููุท ุจุฑุง ุฐุฎุฑู ูุถุนุช job ุงุณุชูุงุฏู ูโุดุฏ
- **ุฑุงูโุญู**:
  - ุงุฌุงุฏ ุณุฑูุณ `ScheduledTaskService` ุฏุฑ `src/Modules/AIAgent/Services/ScheduledTaskService.php`
  - ูพุดุชุจุงู ุงุฒ ุงููุงุน ูุธุงู:
    - `price_change`: ุชุบุฑุงุช ููุช ุฒูุงูโุจูุฏ ุดุฏู
    - `followup`: ูพฺฏุฑโูุง ุฒูุงูโุจูุฏ ุดุฏู
    - `campaign`: ฺฉููพูโูุง ุฒูุงูโุจูุฏ ุดุฏู
    - `inventory_check`: ุจุฑุฑุณ ููุฌูุฏ
  - ุจุฑูุฒุฑุณุงู `ScheduleFollowupAction` ู `SchedulePriceChangeAction` ุจุฑุง ุงุณุชูุงุฏู ุงุฒ ุณุฑูุณ ุฌุฏุฏ
  - ูพุฑุฏุงุฒุด ุฎูุฏฺฉุงุฑ ูุธุงู ุณุฑุฑุณุฏ ุดุฏู ุจุง WordPress Cron

### 4. ุฑฺฉูุฑุฏูุง ุฎูุงุตู ุชุญูู (run) ุฏุฑ ุฌุฏูู analysis โ
- **ูุดฺฉู**: ุฑฺฉูุฑุฏูุง ุจุง `entity_type = 'run'` ู `entity_id = 0` ุฏุฑ ุฌุฏูู `aiagent_analysis` ุฐุฎุฑู ูโุดุฏูุฏ ฺฉู ุจุงุนุซ ุณุฑุฏุฑฺฏู ูโุดุฏ
- **ุชูุถุญ**: ุงู ุฑฺฉูุฑุฏูุง ุฎูุงุตู ูุฑ batch ุชุญูู ูุณุชูุฏ (ุชุนุฏุงุฏ ูุญุตููุงุช ุชุญูู ุดุฏูุ ุงูุฏุงูุงุช ุงุฌุงุฏ ุดุฏู ู...)
- **ุฑุงูโุญู**:
  - ุจุฑูุฒุฑุณุงู `getAnalyses()` ุจุฑุง ููุชุฑ ฺฉุฑุฏู ุฎูุฏฺฉุงุฑ ุฑฺฉูุฑุฏูุง `entity_type = 'run'`
  - ุจุฑูุฒุฑุณุงู `getTodayAnalysesCount()` ู `getTotalAnalysesCount()` ุจุฑุง exclude ฺฉุฑุฏู run records
  - ุจุฑูุฒุฑุณุงู `getRecentAnalyses()` ุจุฑุง exclude ฺฉุฑุฏู run records
  - ุจุฑูุฒุฑุณุงู `getPaginatedAnalyses()` ุจุฑุง exclude ฺฉุฑุฏู run records
  - ุจุฑูุฒุฑุณุงู `getAnalysesCountByType()` ุจุฑุง exclude ฺฉุฑุฏู run records
  - ุจุฑูุฒุฑุณุงู `getAnalysesByDay()` ุจุฑุง exclude ฺฉุฑุฏู run records
  - ุจุฑูุฒุฑุณุงู `getStatistics()` ุจุฑุง exclude ฺฉุฑุฏู run records ุงุฒ ุขูุงุฑ ุฑูุฒุงูู
  - ุจุฑูุฒุฑุณุงู `getTotalTokensUsed()` ุจุฑุง exclude ฺฉุฑุฏู run records
  - ุจุฑูุฒุฑุณุงู `getAvgResponseTime()` ุจุฑุง exclude ฺฉุฑุฏู run records
  - ุงุถุงูู ฺฉุฑุฏู ูุชุฏ ุฌุฏุฏ `getAnalysisRunHistory()` ุจุฑุง ุฏุณุชุฑุณ ุจู ุชุงุฑุฎฺู ุงุฌุฑุงูุง ุฏุฑ ุตูุฑุช ูุงุฒ

---

## ๐ก ุจูุจูุฏูุง ูพุดููุงุฏ (ุงูููุช ูุชูุณุท)

### 4. ฺฉูพุงุฑฺูโุณุงุฒ ContextManager ุจุง Analyzers
- **ูุถุนุช**: ุณุฑูุณ ุงุฌุงุฏ ุดุฏู ุงูุง ูููุฒ ุฏุฑ ProductAnalyzer ู CustomerAnalyzer ุงุณุชูุงุฏู ูุดุฏู
- **ูพุดููุงุฏ**: 
  - ุงุณุชูุงุฏู ุงุฒ `ContextManager::buildSystemPrompt()` ุฏุฑ analyzers
  - ุงูฺฉุงู ุณูุงุฑุดโุณุงุฒ ูพุฑุงููพุชโูุง ุงุฒ ุทุฑู ูพูู ูุฏุฑุช

### 5. ุงูุฒูุฏู UI ุจุฑุง ูุฏุฑุช ูุธุงู ุฒูุงูโุจูุฏ ุดุฏู
- **ูุถุนุช**: ุณุฑูุณ backend ุขูุงุฏู ุงุณุช
- **ูพุดููุงุฏ**:
  - ุตูุญู ูุฏุฑุช ูุธุงู ุฒูุงูโุจูุฏ ุดุฏู ุฏุฑ ูพูู ุงุฏูู
  - ููุงุด ูุณุช ูุธุงู pending
  - ุงูฺฉุงู ูุบู ูุธุงู
  - ููุงุด ุชุงุฑุฎฺู ุงุฌุฑุง

### 6. ุงูุฒูุฏู UI ุจุฑุง ูุฏุฑุช Context/Prompts
- **ูุถุนุช**: ุณุฑูุณ backend ุขูุงุฏู ุงุณุช
- **ูพุดููุงุฏ**:
  - ุตูุญู ูุฑุงุด ูพุฑุงููพุชโูุง ุณุณุชู
  - ุงูฺฉุงู ุงุฌุงุฏ ูุงูุจโูุง ุงูู ู ูพุงูฺฉ ุณูุงุฑุด
  - import/export ุชูุธูุงุช

---

## ๐ต ูฺฺฏโูุง ุฌุฏุฏ (ุงูููุช ูพุงู)

### 7. ุณุณุชู ูุงูุจโูุง ุงูู ู ูพุงูฺฉ
- ุงุณุชูุงุฏู ุงุฒ `ContextManager` ุจุฑุง ุฐุฎุฑู ูุงูุจโูุง
- ูุชุบุฑูุง ูพูุง ูุงููุฏ `{{customer_name}}`, `{{product_name}}`
- ูพุดโููุงุด ูุงูุจ ูุจู ุงุฒ ุงุฑุณุงู

### 8. ฺฏุฒุงุฑุดโฺฏุฑ ุงุฒ ูุธุงู ุฒูุงูโุจูุฏ ุดุฏู
- ุขูุงุฑ ุงุฌุฑุง ูุธุงู
- ูุฑุฎ ููููุช/ุดฺฉุณุช
- ูุงูฺฏู ุฒูุงู ุงุฌุฑุง

---

## ๐ ุงุฏุฏุงุดุชโูุง ูู

### ุณุฑูุณโูุง ุฌุฏุฏ ุงุถุงูู ุดุฏู:
1. **ContextManager** (`src/Modules/AIAgent/Services/ContextManager.php`)
   - ูุฏุฑุช ูพุฑุงููพุชโูุง ู ูุงูุจโูุง
   - ุฐุฎุฑู ุฏุฑ ุฌุฏูู `aiagent_context`
   - ูุชุฏูุง ุงุตู: `get()`, `save()`, `buildSystemPrompt()`, `getEmailTemplate()`, `getSmsTemplate()`

2. **ScheduledTaskService** (`src/Modules/AIAgent/Services/ScheduledTaskService.php`)
   - ูุฏุฑุช ูุธุงู ุฒูุงูโุจูุฏ ุดุฏู
   - ุฐุฎุฑู ุฏุฑ ุฌุฏูู `aiagent_scheduled`
   - ูุชุฏูุง ุงุตู: `schedule()`, `schedulePriceChange()`, `scheduleFollowup()`, `processDueTasks()`

### ุชุบุฑุงุช ุฏุฑ ูุงูโูุง ููุฌูุฏ:
- `AIAgentModule.php`: ุซุจุช ุณุฑูุณโูุง ุฌุฏุฏ ู initialization
- `ScheduleFollowupAction.php`: ุงุณุชูุงุฏู ุงุฒ ScheduledTaskService
- `SchedulePriceChangeAction.php`: ุงุณุชูุงุฏู ุงุฒ ScheduledTaskService
